<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ZotWatch 文献归档</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'bg-primary': '#f8fafc',
            'bg-card': '#ffffff',
            'bg-hover': '#f1f5f9',
            'text-primary': '#1e293b',
            'text-secondary': '#64748b',
            'border-color': '#e2e8f0',
            'accent': '#2563eb',
            'accent-hover': '#1d4ed8',
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .content-container {
      max-width: 64rem;
      margin: 0 auto;
      padding: 0 1rem;
    }

    @media (min-width: 768px) {
      .content-container {
        padding: 0 2rem;
      }
    }

    .section-expand {
      transition: max-height 0.3s ease-out;
      overflow: hidden;
    }

    .section-expand.collapsed {
      max-height: 0;
    }

    .section-expand.expanded {
      max-height: none;
    }

    .view-btn.active {
      background-color: #2563eb;
      color: white;
    }

    .filter-tag {
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-tag:hover {
      background-color: #dbeafe;
    }

    .filter-tag.active {
      background-color: #2563eb;
      color: white;
    }
  </style>
</head>

<body class="bg-bg-primary min-h-screen text-text-primary">
  <!-- Header -->
  <header class="bg-bg-card border-b border-border-color sticky top-0 z-10">
    <div class="content-container py-4 md:py-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h1 class="text-xl md:text-2xl font-bold text-text-primary">ZotWatch 文献归档</h1>
          <p class="text-xs md:text-sm text-text-secondary mt-1">
            共 <span id="stat-total">52</span> 篇论文 ·
            最后更新: 2026-01-29 00:17 Asia/Shanghai
          </p>
        </div>
        <!-- Stats badges -->
        <div class="flex flex-wrap gap-2">
          <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
            必读 <span id="stat-must-read">1</span>
          </span>
          <span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm font-medium">
            推荐 <span id="stat-consider">26</span>
          </span>
          <span class="px-3 py-1 bg-bg-hover text-text-secondary rounded-full text-sm">
            参考 <span id="stat-ignore">25</span>
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- Filter Bar -->
  <nav class="bg-bg-card border-b border-border-color py-3">
    <div class="content-container">
      <!-- View Switcher -->
      <div class="flex flex-wrap items-center gap-3 mb-3">
        <span class="text-sm text-text-secondary">分组方式:</span>
        <div class="flex gap-1">
          <a href="archive.html"
            class="view-btn px-3 py-1.5 rounded text-sm transition-colors hover:bg-bg-hover ">按日期</a>
          <a href="archive-venue.html"
            class="view-btn px-3 py-1.5 rounded text-sm transition-colors hover:bg-bg-hover active">按期刊</a>
          <a href="archive-source.html"
            class="view-btn px-3 py-1.5 rounded text-sm transition-colors hover:bg-bg-hover ">按来源</a>
          <a href="archive-label.html"
            class="view-btn px-3 py-1.5 rounded text-sm transition-colors hover:bg-bg-hover ">按标签</a>
        </div>
      </div>

      <!-- Filters -->
      <div class="flex flex-wrap items-center gap-3">
        <span class="text-sm text-text-secondary">筛选:</span>
        <!-- Source Filter -->
        <div class="flex gap-1" id="source-filters"></div>
        <!-- Label Filter -->
        <div class="flex gap-1">
          <span class="filter-tag px-2 py-1 bg-green-50 text-green-700 rounded text-xs" data-filter="label"
            data-value="must_read">必读</span>
          <span class="filter-tag px-2 py-1 bg-amber-50 text-amber-700 rounded text-xs" data-filter="label"
            data-value="consider">推荐</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="py-6">
    <div class="content-container">
      <div id="archive-groups" class="space-y-8"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-bg-card border-t border-border-color mt-12">
    <div class="content-container py-6 text-center text-sm text-text-secondary">
      灵感来自 <a href="https://github.com/Yorks0n/ZotWatch"
        class="text-accent hover:text-accent-hover transition-colors">ZotWatch</a>
      · 数据来源: arXiv, Crossref, EarthArXiv
    </div>
  </footer>

  <script>
    // Performance-optimized archive viewer for large datasets (10k+ papers)
    (function() {
      'use strict';

      // Configuration
      const CONFIG = {
        pageSize: 50,              // Items per chunk
        scrollThreshold: 300,     // px from bottom to trigger load
        debounceDelay: 150,       // ms debounce for filters
        virtualItemHeight: 280,   // Estimated item height for virtual scroll
        maxVisibleItems: 100,     // Max DOM items per group before recycling
      };

      const dataUrl = "archive-venue-data.json";
      const activeFilters = { source: new Set(), label: new Set() };
      let archiveData = null;
      let groupStates = new Map(); // Track render state per group
      let intersectionObserver = null;

      // Utility functions
      function normalizeGroupId(name) {
        return name.toLowerCase().replace(/[^a-z0-9]+/gi, '-');
      }

      function formatDate(value) {
        if (!value) return '未知';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return value;
        return date.toISOString().slice(0, 10);
      }

      function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function debounce(fn, delay) {
        let timer = null;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      // Toggle section (for abstracts)
      window.toggleSection = function(id) {
        const el = document.getElementById(id);
        const icon = document.getElementById('icon-' + id);
        if (!el) return;
        const isCollapsed = el.classList.contains('collapsed');
        el.classList.toggle('collapsed', !isCollapsed);
        el.classList.toggle('expanded', isCollapsed);
        if (icon) icon.style.transform = isCollapsed ? 'rotate(180deg)' : 'rotate(0deg)';
      };

      function updateStats(stats) {
        if (!stats) return;
        const total = stats.total ?? 0;
        const mustRead = stats.must_read ?? 0;
        const consider = stats.consider ?? 0;
        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-must-read').textContent = mustRead;
        document.getElementById('stat-consider').textContent = consider;
        document.getElementById('stat-ignore').textContent = Math.max(0, total - mustRead - consider);
      }

      function buildSourceFilters(sources) {
        const container = document.getElementById('source-filters');
        const fragment = document.createDocumentFragment();
        sources.forEach(src => {
          const tag = document.createElement('span');
          tag.className = 'filter-tag px-2 py-1 bg-bg-hover rounded text-xs';
          tag.dataset.filter = 'source';
          tag.dataset.value = src.source;
          tag.textContent = `${src.source} (${src.count})`;
          tag.addEventListener('click', handleFilterClick);
          fragment.appendChild(tag);
        });
        container.innerHTML = '';
        container.appendChild(fragment);
      }

      function handleFilterClick(event) {
        const tag = event.currentTarget;
        const type = tag.dataset.filter;
        const value = tag.dataset.value;
        tag.classList.toggle('active');
        if (tag.classList.contains('active')) {
          activeFilters[type].add(value);
        } else {
          activeFilters[type].delete(value);
        }
        debouncedRender();
      }

      function matchesFilters(work) {
        if (activeFilters.source.size > 0 && !activeFilters.source.has(work.source)) return false;
        if (activeFilters.label.size > 0 && !activeFilters.label.has(work.label)) return false;
        return true;
      }

      // Pre-filter works once and cache results
      function getFilteredGroups(data) {
        if (!data) return [];
        return data.groups.map(group => ({
          ...group,
          filteredWorks: group.works.filter(matchesFilters)
        })).filter(g => g.filteredWorks.length > 0);
      }

      // Create article HTML using template literals (faster than DOM manipulation)
      function createArticleHTML(work, groupId, idx) {
        const published = work.published ? formatDate(work.published) : formatDate(work.extra?.run_date);
        const labelText = work.label === 'must_read' ? '必读' : (work.label === 'consider' ? '推荐' : '参考');
        const labelClass = work.label === 'must_read'
          ? 'bg-green-100 text-green-700 border border-green-300'
          : (work.label === 'consider' ? 'bg-amber-100 text-amber-700 border border-amber-300' : 'bg-bg-hover text-text-secondary border border-border-color');
        const abstractId = `abs-${groupId}-${idx}`;
        const title = escapeHtml(work.title);
        const venue = escapeHtml(work.venue || '未知来源');
        const authors = (work.authors || []).slice(0, 5).map(escapeHtml).join('，');
        const hasMore = (work.authors || []).length > 5;

        return `<article class="paper-card bg-bg-card rounded-lg border border-border-color overflow-hidden hover:border-accent/50 transition-colors" data-idx="${idx}">
          <div class="p-4 md:p-5">
            <div class="flex items-center gap-2 mb-2 flex-wrap">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium ${labelClass}">${labelText}</span>
              <span class="text-xs text-text-secondary">评分 ${work.score.toFixed(2)}</span>
              <span class="text-xs text-text-secondary">·</span>
              <span class="text-xs text-text-secondary">${escapeHtml(work.source)}</span>
              <span class="text-xs text-text-secondary">· ${published}</span>
            </div>
            <div class="mb-2">
              <h3 class="text-base md:text-lg font-semibold text-text-primary leading-tight">
                <a href="${escapeHtml(work.url || '#')}" target="_blank" rel="noopener" class="hover:text-accent transition-colors">${title}</a>
              </h3>
              ${work.translated_title ? `<p class="text-sm text-text-secondary mt-0.5 leading-snug">${escapeHtml(work.translated_title)}</p>` : ''}
            </div>
            <div class="text-xs text-text-secondary mb-2">${venue}${work.is_chinese_core ? '<span class="ml-1 px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded">中文核心</span>' : ''}${!work.is_chinese_core && work.impact_factor ? `<span class="ml-1 text-blue-600">(IF: ${work.impact_factor.toFixed(1)})</span>` : ''}</div>
            <p class="text-sm text-text-secondary mb-3">${authors}${hasMore ? ' 等' : ''}</p>
            ${work.doi ? `<div class="text-xs text-text-secondary mb-3"><span class="font-medium mr-1">DOI:</span><a href="https://doi.org/${escapeHtml(work.doi)}" target="_blank" rel="noopener" class="text-accent hover:underline">${escapeHtml(work.doi)}</a></div>` : ''}
            ${work.abstract ? `<div class="bg-bg-hover/50 rounded-lg p-3 mb-3 border border-border-color">
              <button onclick="toggleSection('${abstractId}')" class="w-full text-left text-sm font-medium text-text-primary flex items-center justify-between">
                <span>原文摘要</span>
                <svg class="w-4 h-4 text-text-secondary transform transition-transform" id="icon-${abstractId}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div id="${abstractId}" class="section-expand collapsed"><p class="text-sm text-text-secondary mt-2 leading-relaxed">${escapeHtml(work.abstract)}</p></div>
            </div>` : ''}
            <div class="pt-3 border-t border-border-color">
              <div class="flex flex-wrap gap-2 text-xs">
                <span class="px-2 py-1 bg-bg-hover rounded text-text-secondary">相似度 ${work.similarity.toFixed(2)}</span>
                <span class="px-2 py-1 bg-bg-hover rounded text-text-secondary">期刊影响力 ${work.impact_factor_score.toFixed(2)}</span>
              </div>
            </div>
          </div>
        </article>`;
      }

      // Render a chunk of items for a group
      function renderChunk(state, count = CONFIG.pageSize) {
        const { works, list, groupId } = state;
        const start = state.rendered;
        const end = Math.min(start + count, works.length);
        if (start >= end) return;

        // Use insertAdjacentHTML for better performance than innerHTML
        const htmlParts = [];
        for (let i = start; i < end; i++) {
          htmlParts.push(createArticleHTML(works[i], groupId, i));
        }
        list.insertAdjacentHTML('beforeend', htmlParts.join(''));
        state.rendered = end;

        // Update load more button visibility
        const btn = state.loadMoreBtn;
        if (btn) {
          if (state.rendered >= works.length) {
            btn.style.display = 'none';
          } else {
            btn.textContent = `加载更多 (${works.length - state.rendered} 剩余)`;
          }
        }
      }

      // Setup Intersection Observer for lazy loading
      function setupLazyLoad(state) {
        if (!intersectionObserver) {
          intersectionObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const groupId = entry.target.dataset.groupId;
                const state = groupStates.get(groupId);
                if (state && state.rendered < state.works.length) {
                  renderChunk(state);
                }
              }
            });
          }, { rootMargin: '200px' });
        }

        // Create sentinel element for infinite scroll
        const sentinel = document.createElement('div');
        sentinel.className = 'load-sentinel h-1';
        sentinel.dataset.groupId = state.groupId;
        state.list.parentElement.appendChild(sentinel);
        intersectionObserver.observe(sentinel);
        state.sentinel = sentinel;
      }

      function renderGroups(data) {
        const container = document.getElementById('archive-groups');

        // Clear previous observers
        if (intersectionObserver) {
          intersectionObserver.disconnect();
        }
        groupStates.clear();

        const filteredGroups = getFilteredGroups(data);

        // Build all HTML at once for initial render
        const fragment = document.createDocumentFragment();

        filteredGroups.forEach((group, gIdx) => {
          const groupId = `g${gIdx}-${normalizeGroupId(group.name)}`;
          const section = document.createElement('section');
          section.className = 'mb-8';
          section.dataset.group = group.name;

          // Header
          const header = document.createElement('div');
          header.className = 'flex items-center justify-between mb-4 pb-2 border-b border-border-color';

          let titleContent = '';
          if (data.group_by === 'label') {
            const dotClass = group.name === 'must_read' ? 'bg-green-500' : (group.name === 'consider' ? 'bg-amber-500' : 'bg-gray-400');
            const labelName = group.name === 'must_read' ? '必读' : (group.name === 'consider' ? '推荐' : '参考');
            titleContent = `<span class="w-3 h-3 rounded-full ${dotClass}"></span>${labelName}`;
          } else {
            titleContent = escapeHtml(group.name);
          }

          header.innerHTML = `
            <h2 class="text-lg font-bold text-text-primary flex items-center gap-2">${titleContent}</h2>
            <span class="text-sm text-text-secondary">${group.filteredWorks.length} 篇</span>
          `;
          section.appendChild(header);

          // List container
          const list = document.createElement('div');
          list.className = 'space-y-4';
          section.appendChild(list);

          // Load more button
          const loadMoreBtn = document.createElement('button');
          loadMoreBtn.className = 'mt-4 w-full px-4 py-2 text-sm font-medium text-accent border border-accent/30 rounded hover:bg-accent/10 transition-colors';
          loadMoreBtn.style.display = group.filteredWorks.length > CONFIG.pageSize ? 'block' : 'none';
          section.appendChild(loadMoreBtn);

          // Track state
          const state = {
            groupId,
            works: group.filteredWorks,
            list,
            rendered: 0,
            loadMoreBtn,
            sentinel: null
          };
          groupStates.set(groupId, state);

          // Load more click handler
          loadMoreBtn.addEventListener('click', () => renderChunk(state));

          // Initial render
          renderChunk(state);

          // Setup lazy loading for remaining items
          if (state.works.length > state.rendered) {
            setupLazyLoad(state);
          }

          fragment.appendChild(section);
        });

        container.innerHTML = '';
        container.appendChild(fragment);

        // Update filtered stats
        const filteredTotal = filteredGroups.reduce((sum, g) => sum + g.filteredWorks.length, 0);
        const filteredMustRead = filteredGroups.reduce((sum, g) =>
          sum + g.filteredWorks.filter(w => w.label === 'must_read').length, 0);
        const filteredConsider = filteredGroups.reduce((sum, g) =>
          sum + g.filteredWorks.filter(w => w.label === 'consider').length, 0);

        if (activeFilters.source.size > 0 || activeFilters.label.size > 0) {
          document.getElementById('stat-total').textContent = `${filteredTotal} / ${data.stats.total}`;
        }
      }

      // Debounced render for filter changes
      const debouncedRender = debounce(() => {
        if (archiveData) renderGroups(archiveData);
      }, CONFIG.debounceDelay);

      // Initialize filter click handlers
      document.querySelectorAll('.filter-tag').forEach(tag => {
        tag.addEventListener('click', handleFilterClick);
      });

      // Load data
      fetch(dataUrl)
        .then(response => response.json())
        .then(data => {
          archiveData = data;
          updateStats(data.stats);
          buildSourceFilters(data.sources || []);
          renderGroups(data);
        })
        .catch(err => {
          console.error('Failed to load archive data:', err);
          document.getElementById('archive-groups').innerHTML =
            '<p class="text-center text-red-500 py-8">加载数据失败，请刷新页面重试</p>';
        });
    })();
  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ZotWatch æ–‡çŒ®å½’æ¡£</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'bg-primary': '#f8fafc',
            'bg-card': '#ffffff',
            'bg-hover': '#f1f5f9',
            'text-primary': '#1e293b',
            'text-secondary': '#64748b',
            'border-color': '#e2e8f0',
            'accent': '#4f46e5',
            'accent-hover': '#4338ca',
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .content-container {
      max-width: 72rem;
      margin: 0 auto;
      padding: 0 1rem;
    }

    @media (min-width: 768px) {
      .content-container {
        padding: 0 2rem;
      }
    }

    .section-expand {
      transition: max-height 0.3s ease-out;
      overflow: hidden;
    }

    .section-expand.collapsed {
      max-height: 0;
    }

    .section-expand.expanded {
      max-height: none;
    }

    /* Pill button styles */
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 0.375rem 0.875rem;
      border: 1.5px solid #c7d2fe;
      border-radius: 9999px;
      font-size: 0.8125rem;
      font-weight: 500;
      color: #4f46e5;
      background: white;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
      user-select: none;
    }

    .pill:hover {
      background: #eef2ff;
      border-color: #a5b4fc;
    }

    .pill.active {
      background: #4f46e5;
      color: white;
      border-color: #4f46e5;
    }

    .pill.active:hover {
      background: #4338ca;
      border-color: #4338ca;
    }

    /* Navigation pill (link) */
    a.pill {
      text-decoration: none;
    }

    .group-header {
      cursor: pointer;
      user-select: none;
    }

    .group-header:hover {
      background-color: #f8fafc;
    }

    .group-content {
      transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
    }

    .group-content.collapsed {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
    }

    .rotate-icon {
      transition: transform 0.2s ease-out;
    }

    .rotate-icon.collapsed {
      transform: rotate(-90deg);
    }

    /* Compact view styles */
    .compact-view .paper-card {
      padding: 0.75rem !important;
    }

    .compact-view .paper-card h3 {
      font-size: 0.875rem !important;
    }

    .compact-view .paper-abstract {
      display: none;
    }

    .compact-view .paper-details {
      display: none;
    }

    /* Content visibility optimization for large lists */
    .paper-card {
      content-visibility: auto;
      contain-intrinsic-size: auto 120px;
    }

    .group-content {
      content-visibility: auto;
      contain-intrinsic-size: auto 500px;
    }

    /* Loading spinner */
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4f46e5;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Back to top button */
    #back-to-top {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    #back-to-top.visible {
      opacity: 1;
      visibility: visible;
    }

    /* Search highlight */
    .search-highlight {
      background-color: #fef08a;
      padding: 0 2px;
      border-radius: 2px;
    }

    /* Author group header accent */
    .group-header-author {
      border-left: 3px solid #6366f1;
      background: linear-gradient(to right, #eef2ff, #ffffff);
    }

    .group-header-ai {
      border-left: 3px solid #f59e0b;
      background: linear-gradient(to right, #fffbeb, #ffffff);
    }

    /* Paper checkbox */
    .paper-check {
      width: 1.125rem;
      height: 1.125rem;
      accent-color: #4f46e5;
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 0.125rem;
    }

    .paper-card.selected {
      border-color: #a5b4fc;
      background: #fafafe;
    }

    /* Bottom toolbar */
    .bottom-toolbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 40;
      background: white;
      border-top: 1px solid #e2e8f0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.06);
      padding: 0.75rem 1rem;
      transform: translateY(0);
      transition: transform 0.2s ease;
    }

    /* Export dropdown */
    .export-dropdown {
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 0.5rem;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
      min-width: 12rem;
    }

    .export-dropdown button {
      display: block;
      width: 100%;
      text-align: left;
      padding: 0.625rem 1rem;
      font-size: 0.875rem;
      transition: background 0.1s;
    }

    .export-dropdown button:hover {
      background: #f1f5f9;
    }

    /* Ensure content doesn't hide behind toolbar */
    body {
      padding-bottom: 4.5rem;
    }
  </style>
</head>

<body class="bg-bg-primary min-h-screen text-text-primary">
  <!-- Header -->
  <header class="bg-bg-card border-b border-border-color">
    <div class="content-container py-5">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h1 class="text-xl md:text-2xl font-bold text-text-primary">ZotWatch æ–‡çŒ®å½’æ¡£</h1>
          <p class="text-xs md:text-sm text-text-secondary mt-1">
            å…± <span id="stat-total" class="font-semibold text-text-primary">1281</span> ç¯‡ Â·
            æ›´æ–°: 2026-02-09 07:46
          </p>
        </div>
        <div class="flex items-center gap-2">
          <button id="toggle-view" class="px-3 py-1.5 border border-border-color rounded-lg text-sm hover:bg-bg-hover flex items-center gap-2" title="åˆ‡æ¢è§†å›¾">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
            </svg>
            <span id="view-label">å®Œæ•´</span>
          </button>
          <button id="expand-all" class="px-3 py-1.5 border border-border-color rounded-lg text-sm hover:bg-bg-hover" title="å±•å¼€/æŠ˜å å…¨éƒ¨">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Filter Section -->
  <section class="bg-bg-card border-b border-border-color">
    <div class="content-container py-4 space-y-3">

      <!-- åˆ†ç»„æ–¹å¼ -->
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-sm font-medium text-text-secondary w-20 shrink-0">ğŸ“‹ åˆ†ç»„:</span>
        <div class="flex flex-wrap gap-1.5">
          <a href="archive.html" class="pill ">æ—¥æœŸ</a>
          <a href="archive-year.html" class="pill active">å¹´ä»½</a>
          <a href="archive-venue.html" class="pill ">æœŸåˆŠ</a>
          <a href="archive-source.html" class="pill ">æ¥æº</a>
          <a href="archive-label.html" class="pill ">æ ‡ç­¾</a>
          <a href="archive-domain.html" class="pill ">é¢†åŸŸ</a>
          <a href="archive-author.html" class="pill ">ä½œè€…</a>
        </div>
      </div>

      <!-- æœˆä»½ -->
      <div class="flex flex-wrap items-center gap-2" id="month-row" style="display:none">
        <span class="text-sm font-medium text-text-secondary w-20 shrink-0">ğŸ“… æœˆä»½:</span>
        <select id="month-select" class="pill" style="padding-right:2rem;appearance:auto;">
          <option value="">å…¨éƒ¨æœˆä»½</option>
        </select>
      </div>

      <!-- æ ‡ç­¾ -->
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-sm font-medium text-text-secondary w-20 shrink-0">â­ æ ‡ç­¾:</span>
        <div class="flex flex-wrap gap-1.5" id="label-pills">
          <button class="pill active" data-filter="label" data-value="">å…¨éƒ¨</button>
          <button class="pill" data-filter="label" data-value="must_read">å¿…è¯» (<span id="stat-must-read">0</span>)</button>
          <button class="pill" data-filter="label" data-value="consider">æ¨è (<span id="stat-consider">0</span>)</button>
          <button class="pill" data-filter="label" data-value="followed" id="followed-badge">å…³æ³¨ (<span id="stat-followed">0</span>)</button>
          <button class="pill" data-filter="label" data-value="ignore">å‚è€ƒ (<span id="stat-ignore">0</span>)</button>
        </div>
      </div>

      <!-- ç ”ç©¶é¢†åŸŸ -->
      <div class="flex flex-wrap items-center gap-2" id="domain-row" style="display:none">
        <span class="text-sm font-medium text-text-secondary w-20 shrink-0">ğŸ”¬ é¢†åŸŸ:</span>
        <div class="flex flex-wrap gap-1.5" id="domain-pills"></div>
      </div>

      <!-- æ¥æº -->
      <div class="flex flex-wrap items-center gap-2" id="source-row" style="display:none">
        <span class="text-sm font-medium text-text-secondary w-20 shrink-0">ğŸ“š æ¥æº:</span>
        <div class="flex flex-wrap gap-1.5" id="source-pills"></div>
      </div>

      <!-- å…³æ³¨ä½œè€… -->
      <div class="flex flex-wrap items-center gap-2" id="author-row" style="display:none">
        <span class="text-sm font-medium text-text-secondary w-20 shrink-0">ğŸ‘¤ å…³æ³¨:</span>
        <div class="flex flex-wrap gap-1.5" id="author-pills"></div>
      </div>

      <!-- æ’åºæ–¹å¼ -->
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-sm font-medium text-text-secondary w-20 shrink-0">ğŸ”„ æ’åº:</span>
        <div class="flex flex-wrap gap-1.5" id="sort-pills">
          <button class="pill active" data-sort="newest">æœ€æ–°ä¼˜å…ˆ</button>
          <button class="pill" data-sort="oldest">æœ€æ—©ä¼˜å…ˆ</button>
          <button class="pill" data-sort="score">è¯„åˆ†ä¼˜å…ˆ</button>
        </div>
      </div>

      <!-- æœç´¢ -->
      <div class="relative mt-1">
        <input type="text" id="search-input" placeholder="ğŸ” æœç´¢è®ºæ–‡æ ‡é¢˜ã€ä½œè€…ã€æ‘˜è¦..."
          class="w-full pl-4 pr-10 py-2.5 border border-border-color rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent bg-bg-primary">
        <button id="clear-search" class="absolute right-3 top-1/2 -translate-y-1/2 text-text-secondary hover:text-text-primary hidden">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

    </div>
  </section>

  <!-- Loading Indicator -->
  <div id="loading" class="flex flex-col items-center justify-center py-20">
    <div class="spinner mb-4"></div>
    <p class="text-text-secondary">åŠ è½½ä¸­...</p>
  </div>

  <!-- Main Content -->
  <main class="py-6 hidden" id="main-content">
    <div class="content-container">
      <!-- Search Results Info -->
      <div id="search-info" class="mb-4 text-sm text-text-secondary hidden"></div>
      <!-- Archive Groups -->
      <div id="archive-groups" class="space-y-6"></div>
      <!-- No Results -->
      <div id="no-results" class="text-center py-12 hidden">
        <svg class="w-16 h-16 mx-auto text-text-secondary/50 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p class="text-text-secondary">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡çŒ®</p>
        <button id="reset-search" class="mt-4 text-accent hover:text-accent-hover text-sm">é‡ç½®æœç´¢</button>
      </div>
    </div>
  </main>

  <!-- Bottom Toolbar -->
  <div class="bottom-toolbar" id="bottom-toolbar">
    <div class="content-container flex items-center justify-between">
      <span class="text-sm text-text-secondary">
        æ˜¾ç¤º <span id="visible-count" class="font-semibold text-text-primary">0</span> ç¯‡è®ºæ–‡
      </span>
      <div class="flex items-center gap-2 relative">
        <button id="select-all-btn" class="px-3 py-1.5 text-sm border border-border-color rounded-lg hover:bg-bg-hover flex items-center gap-1.5">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
          å…¨é€‰
        </button>
        <button id="clear-selection-btn" class="px-3 py-1.5 text-sm border border-border-color rounded-lg hover:bg-bg-hover flex items-center gap-1.5">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          æ¸…ç©º
        </button>
        <button id="export-btn" class="px-4 py-1.5 text-sm text-white bg-accent hover:bg-accent-hover rounded-lg flex items-center gap-1.5 transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          å¯¼å‡ºé€‰ä¸­ (<span id="selected-count">0</span>)
        </button>
        <!-- Export dropdown -->
        <div id="export-dropdown" class="export-dropdown hidden">
          <button data-format="ris" class="flex items-center gap-2 text-text-primary">
            <span class="text-lg">ğŸ“„</span>
            <div>
              <div class="font-medium">RIS æ ¼å¼</div>
              <div class="text-xs text-text-secondary">é€‚ç”¨äº Zotero / Mendeley / EndNote</div>
            </div>
          </button>
          <button data-format="bibtex" class="flex items-center gap-2 text-text-primary">
            <span class="text-lg">ğŸ“</span>
            <div>
              <div class="font-medium">BibTeX æ ¼å¼</div>
              <div class="text-xs text-text-secondary">é€‚ç”¨äº LaTeX / JabRef / Overleaf</div>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Back to Top Button -->
  <button id="back-to-top" class="fixed bottom-20 right-6 w-12 h-12 bg-accent text-white rounded-full shadow-lg hover:bg-accent-hover flex items-center justify-center z-30" title="è¿”å›é¡¶éƒ¨">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
    </svg>
  </button>

  <!-- Footer -->
  <footer class="bg-bg-card border-t border-border-color mt-12">
    <div class="content-container py-6 text-center text-sm text-text-secondary">
      çµæ„Ÿæ¥è‡ª <a href="https://github.com/Yorks0n/ZotWatch" class="text-accent hover:text-accent-hover transition-colors">ZotWatch</a>
      Â· æ•°æ®æ¥æº: arXiv, Crossref, EarthArXiv
    </div>
  </footer>

  <script>
    (function() {
      'use strict';

      const CONFIG = {
        initialPageSize: 10,   // Smaller initial render
        pageSize: 20,          // Load more chunk size
        debounceDelay: 150,
        searchMinLength: 2,
        maxGroupsInitial: 5    // Only render first N groups initially
      };
      const dataUrl = "archive-year-data.json";

      // Filter state: single-select per category
      const filters = { month: '', label: '', domain: '', source: '', author: '', sort: 'newest' };
      let archiveData = null;
      let groupStates = new Map();
      let intersectionObserver = null;
      let groupObserver = null;  // For lazy loading groups
      let searchQuery = '';
      let isCompactView = false;
      let allGroupsExpanded = true;

      // Multi-select state: Set of work identifiers
      const selectedWorks = new Set();

      // Filter cache to avoid recomputation
      let filterCache = { key: '', result: null };

      const LABEL_ORDER = { 'must_read': 0, 'consider': 1, 'followed': 2, 'ignore': 3 };

      // â”€â”€ Utilities â”€â”€

      function normalizeGroupId(name) {
        return name.toLowerCase().replace(/[^a-z0-9]+/gi, '-');
      }

      function formatDate(value) {
        if (!value) return 'æœªçŸ¥';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return value;
        return date.toISOString().slice(0, 10);
      }

      function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function highlightText(text, query) {
        if (!query || !text) return escapeHtml(text);
        const escaped = escapeHtml(text);
        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return escaped.replace(regex, '<span class="search-highlight">$1</span>');
      }

      function debounce(fn, delay) {
        let timer = null;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      function getWorkMonth(work) {
        const d = work.published || (work.extra && work.extra.run_date) || '';
        if (!d) return '';
        return d.slice(0, 7); // YYYY-MM
      }

      // â”€â”€ Toggle UI â”€â”€

      window.toggleSection = function(id) {
        const el = document.getElementById(id);
        const icon = document.getElementById('icon-' + id);
        if (!el) return;
        const isCollapsed = el.classList.contains('collapsed');
        el.classList.toggle('collapsed', !isCollapsed);
        el.classList.toggle('expanded', isCollapsed);
        if (icon) icon.style.transform = isCollapsed ? 'rotate(180deg)' : 'rotate(0deg)';
      };

      window.toggleGroup = function(groupId) {
        const content = document.getElementById(`content-${groupId}`);
        const icon = document.getElementById(`icon-group-${groupId}`);
        if (!content) return;
        const isCollapsed = content.classList.contains('collapsed');
        content.classList.toggle('collapsed', !isCollapsed);
        if (icon) icon.classList.toggle('collapsed', !isCollapsed);
      };

      // â”€â”€ Multi-select â”€â”€

      window.toggleWorkSelect = function(identifier, checkbox) {
        if (checkbox.checked) {
          selectedWorks.add(identifier);
        } else {
          selectedWorks.delete(identifier);
        }
        // Update card style
        const card = checkbox.closest('.paper-card');
        if (card) card.classList.toggle('selected', checkbox.checked);
        updateSelectionUI();
      };

      function updateSelectionUI() {
        document.getElementById('selected-count').textContent = selectedWorks.size;
      }

      function selectAllVisible() {
        document.querySelectorAll('.paper-check').forEach(cb => {
          cb.checked = true;
          selectedWorks.add(cb.dataset.id);
          const card = cb.closest('.paper-card');
          if (card) card.classList.add('selected');
        });
        updateSelectionUI();
      }

      function clearSelection() {
        selectedWorks.clear();
        document.querySelectorAll('.paper-check').forEach(cb => {
          cb.checked = false;
          const card = cb.closest('.paper-card');
          if (card) card.classList.remove('selected');
        });
        updateSelectionUI();
      }

      // â”€â”€ Export â”€â”€

      function getSelectedWorksData() {
        if (!archiveData) return [];
        const works = [];
        archiveData.groups.forEach(g => {
          g.works.forEach(w => {
            if (selectedWorks.has(w.identifier)) works.push(w);
          });
        });
        return works;
      }

      function exportRIS(works) {
        const lines = [];
        works.forEach(w => {
          const isPreprint = (w.source || '').toLowerCase().includes('arxiv');
          lines.push(`TY  - ${isPreprint ? 'UNPB' : 'JOUR'}`);
          lines.push(`TI  - ${w.title || ''}`);
          (w.authors || []).forEach(a => lines.push(`AU  - ${a}`));
          if (w.venue) lines.push(`T2  - ${w.venue}`);
          const year = (w.published || '').slice(0, 4);
          if (year) lines.push(`PY  - ${year}`);
          const pubDate = (w.published || '').slice(0, 10);
          if (pubDate) lines.push(`DA  - ${pubDate.replace(/-/g, '/')}`);
          if (w.doi) lines.push(`DO  - ${w.doi}`);
          if (w.url) lines.push(`UR  - ${w.url}`);
          if (w.abstract) lines.push(`AB  - ${w.abstract}`);
          lines.push('ER  - ');
          lines.push('');
        });
        return lines.join('\n');
      }

      function exportBibTeX(works) {
        const entries = [];
        works.forEach((w, idx) => {
          const firstAuthor = (w.authors && w.authors[0]) ? w.authors[0].replace(/[^a-zA-Z]/g, '') : 'unknown';
          const year = (w.published || '').slice(0, 4) || 'nd';
          const key = `${firstAuthor}${year}_${idx}`;
          const isPreprint = (w.source || '').toLowerCase().includes('arxiv');
          const type = isPreprint ? 'misc' : 'article';

          const fields = [];
          if (w.title) fields.push(`  title = {${w.title}}`);
          if (w.authors && w.authors.length > 0) fields.push(`  author = {${w.authors.join(' and ')}}`);
          if (year !== 'nd') fields.push(`  year = {${year}}`);
          if (w.venue) fields.push(`  journal = {${w.venue}}`);
          if (w.doi) fields.push(`  doi = {${w.doi}}`);
          if (w.url) fields.push(`  url = {${w.url}}`);
          if (w.abstract) {
            const abs = w.abstract.replace(/[{}]/g, '');
            fields.push(`  abstract = {${abs}}`);
          }
          if (isPreprint && w.identifier) fields.push(`  eprint = {${w.identifier}}`);

          entries.push(`@${type}{${key},\n${fields.join(',\n')}\n}`);
        });
        return entries.join('\n\n');
      }

      function downloadFile(content, filename, mime) {
        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
      }

      function doExport(format) {
        const works = getSelectedWorksData();
        if (works.length === 0) return;
        const dateStr = new Date().toISOString().slice(0, 10);
        if (format === 'ris') {
          downloadFile(exportRIS(works), `zotwatch-${dateStr}.ris`, 'application/x-research-info-systems');
        } else if (format === 'bibtex') {
          downloadFile(exportBibTeX(works), `zotwatch-${dateStr}.bib`, 'application/x-bibtex');
        }
        document.getElementById('export-dropdown').classList.add('hidden');
      }

      // â”€â”€ Build pill-based filters â”€â”€

      function buildPillRow(containerId, rowId, items, filterKey) {
        const container = document.getElementById(containerId);
        const row = document.getElementById(rowId);
        if (!items || items.length === 0) {
          if (row) row.style.display = 'none';
          return;
        }
        if (row) row.style.display = 'flex';

        const fragment = document.createDocumentFragment();
        // "All" button
        const allBtn = document.createElement('button');
        allBtn.className = 'pill active';
        allBtn.dataset.filter = filterKey;
        allBtn.dataset.value = '';
        allBtn.textContent = `å…¨éƒ¨ (${items.reduce((s, i) => s + i.count, 0)})`;
        allBtn.addEventListener('click', () => setPillFilter(filterKey, '', containerId));
        fragment.appendChild(allBtn);

        items.forEach(item => {
          const btn = document.createElement('button');
          btn.className = 'pill';
          btn.dataset.filter = filterKey;
          btn.dataset.value = item.value;
          btn.textContent = `${item.label} (${item.count})`;
          btn.addEventListener('click', () => setPillFilter(filterKey, item.value, containerId));
          fragment.appendChild(btn);
        });

        container.innerHTML = '';
        container.appendChild(fragment);
      }

      function setPillFilter(filterKey, value, containerId) {
        filters[filterKey] = value;
        // Update active state in this row
        const container = document.getElementById(containerId);
        container.querySelectorAll('.pill').forEach(p => {
          p.classList.toggle('active', p.dataset.value === value);
        });
        debouncedRender();
      }

      function buildAllFilters(data) {
        // Month dropdown
        const monthCounts = new Map();
        data.groups.forEach(g => g.works.forEach(w => {
          const m = getWorkMonth(w);
          if (m) monthCounts.set(m, (monthCounts.get(m) || 0) + 1);
        }));
        const monthRow = document.getElementById('month-row');
        const monthSelect = document.getElementById('month-select');
        if (monthCounts.size > 0) {
          monthRow.style.display = 'flex';
          const total = [...monthCounts.values()].reduce((a, b) => a + b, 0);
          monthSelect.innerHTML = `<option value="">å…¨éƒ¨æœˆä»½ (${total})</option>`;
          [...monthCounts.entries()]
            .sort((a, b) => b[0].localeCompare(a[0]))
            .forEach(([m, c]) => {
              const opt = document.createElement('option');
              opt.value = m;
              opt.textContent = `${m} (${c})`;
              monthSelect.appendChild(opt);
            });
          monthSelect.addEventListener('change', (e) => {
            filters.month = e.target.value;
            debouncedRender();
          });
        }

        // Domain pills
        const domainCounts = new Map();
        data.groups.forEach(g => g.works.forEach(w => {
          if (w.domain) domainCounts.set(w.domain, (domainCounts.get(w.domain) || 0) + 1);
        }));
        const domains = [...domainCounts.entries()]
          .sort((a, b) => b[1] - a[1])
          .map(([d, c]) => ({ value: d, label: d, count: c }));
        buildPillRow('domain-pills', 'domain-row', domains, 'domain');

        // Source pills
        const srcItems = (data.sources || []).map(s => ({ value: s.source, label: s.source, count: s.count }));
        buildPillRow('source-pills', 'source-row', srcItems, 'source');

        // Author pills
        const authorCounts = new Map();
        data.groups.forEach(g => g.works.forEach(w => {
          const author = w.extra && w.extra.followed_author;
          if (author) authorCounts.set(author, (authorCounts.get(author) || 0) + 1);
        }));
        const authors = [...authorCounts.entries()]
          .sort((a, b) => b[1] - a[1])
          .map(([a, c]) => ({ value: a, label: a, count: c }));
        buildPillRow('author-pills', 'author-row', authors, 'author');

        // Label pills: attach click handlers
        document.querySelectorAll('#label-pills .pill').forEach(btn => {
          btn.addEventListener('click', () => {
            setPillFilter('label', btn.dataset.value, 'label-pills');
          });
        });

        // Sort pills: attach click handlers
        document.querySelectorAll('#sort-pills .pill').forEach(btn => {
          btn.addEventListener('click', () => {
            filters.sort = btn.dataset.sort;
            document.querySelectorAll('#sort-pills .pill').forEach(p => p.classList.toggle('active', p.dataset.sort === filters.sort));
            debouncedRender();
          });
        });
      }

      // â”€â”€ Stats â”€â”€

      function updateStats(stats) {
        if (!stats) return;
        const total = stats.total ?? 0;
        const mustRead = stats.must_read ?? 0;
        const consider = stats.consider ?? 0;
        const followed = stats.followed ?? 0;
        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-must-read').textContent = mustRead;
        document.getElementById('stat-consider').textContent = consider;
        document.getElementById('stat-followed').textContent = followed;
        document.getElementById('stat-ignore').textContent = Math.max(0, total - mustRead - consider - followed);

        const followedAuthors = stats.followed_authors || [];
        if (followedAuthors.length > 0) {
          document.getElementById('followed-badge').title = followedAuthors.map(a => `${a.name}: ${a.count} ç¯‡`).join('\n');
        }
      }

      // â”€â”€ Filter & Sort â”€â”€

      function matchesFilters(work) {
        if (filters.label && work.label !== filters.label) return false;
        if (filters.source && work.source !== filters.source) return false;
        if (filters.domain && work.domain !== filters.domain) return false;
        if (filters.month && getWorkMonth(work) !== filters.month) return false;
        if (filters.author) {
          const fa = (work.extra && work.extra.followed_author) || '';
          if (fa !== filters.author) return false;
        }
        return true;
      }

      function matchesSearch(work) {
        if (!searchQuery || searchQuery.length < CONFIG.searchMinLength) return true;
        const q = searchQuery.toLowerCase();
        return (work.title || '').toLowerCase().includes(q) ||
               (work.abstract || '').toLowerCase().includes(q) ||
               (work.authors || []).join(' ').toLowerCase().includes(q) ||
               (work.venue || '').toLowerCase().includes(q);
      }

      function sortWorks(works) {
        const sorted = [...works];
        if (filters.sort === 'newest') {
          sorted.sort((a, b) => (b.published || '').localeCompare(a.published || ''));
        } else if (filters.sort === 'oldest') {
          sorted.sort((a, b) => (a.published || '').localeCompare(b.published || ''));
        } else if (filters.sort === 'score') {
          sorted.sort((a, b) => (b.score || 0) - (a.score || 0));
        }
        return sorted;
      }

      function getFilterCacheKey() {
        return JSON.stringify({ ...filters, search: searchQuery });
      }

      function getFilteredGroups(data) {
        if (!data) return [];

        // Check cache first
        const cacheKey = getFilterCacheKey();
        if (filterCache.key === cacheKey && filterCache.result) {
          return filterCache.result;
        }

        // Compute filtered groups
        let groups = data.groups.map(group => ({
          ...group,
          filteredWorks: sortWorks(group.works.filter(w => matchesFilters(w) && matchesSearch(w)))
        })).filter(g => g.filteredWorks.length > 0);

        if (data.group_by === 'label') {
          groups.sort((a, b) => (LABEL_ORDER[a.name] ?? 99) - (LABEL_ORDER[b.name] ?? 99));
        }

        if (data.group_by === 'author') {
          groups.sort((a, b) => {
            if (a.name === 'AI æ¨è') return 1;
            if (b.name === 'AI æ¨è') return -1;
            return b.filteredWorks.length - a.filteredWorks.length;
          });
        }

        // Cache result
        filterCache = { key: cacheKey, result: groups };
        return groups;
      }

      // â”€â”€ Rendering â”€â”€

      function buildSummaryHTML(bullets) {
        if (!bullets) return '';
        const items = [
          { label: 'ç ”ç©¶é—®é¢˜', text: bullets.research_question },
          { label: 'æ–¹æ³•', text: bullets.methodology },
          { label: 'å…³é”®å‘ç°', text: bullets.key_findings },
          { label: 'åˆ›æ–°ç‚¹', text: bullets.innovation },
        ];
        if (bullets.relevance_note) items.push({ label: 'ç›¸å…³æ€§', text: bullets.relevance_note });
        return items.map(item =>
          `<div class="flex gap-2"><span class="text-accent font-medium shrink-0">${item.label}:</span><span>${escapeHtml(item.text)}</span></div>`
        ).join('');
      }

      function createArticleHTML(work, groupId, idx) {
        const published = work.published ? formatDate(work.published) : formatDate(work.extra?.run_date);
        const labelText = work.label === 'must_read' ? 'å¿…è¯»' : (work.label === 'consider' ? 'æ¨è' : (work.label === 'followed' ? 'å…³æ³¨' : 'å‚è€ƒ'));
        const labelClass = work.label === 'must_read'
          ? 'bg-green-100 text-green-700'
          : (work.label === 'consider' ? 'bg-amber-100 text-amber-700' : (work.label === 'followed' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'));
        const abstractId = `abs-${groupId}-${idx}`;
        const summaryId = `sum-${groupId}-${idx}`;

        const title = searchQuery ? highlightText(work.title, searchQuery) : escapeHtml(work.title);
        const venue = escapeHtml(work.venue || 'æœªçŸ¥æ¥æº');
        const authorsRaw = (work.authors || []).slice(0, 5);
        const authors = searchQuery
          ? authorsRaw.map(a => highlightText(a, searchQuery)).join('ï¼Œ')
          : authorsRaw.map(escapeHtml).join('ï¼Œ');
        const hasMore = (work.authors || []).length > 5;
        const hasSummary = work.summary_bullets && work.summary_bullets.research_question;
        const isSelected = selectedWorks.has(work.identifier);

        return `<article class="paper-card bg-bg-card rounded-lg border border-border-color p-4 hover:border-accent/30 transition-colors${isSelected ? ' selected' : ''}" data-idx="${idx}">
          <div class="flex items-start gap-3">
            <input type="checkbox" class="paper-check" data-id="${escapeHtml(work.identifier)}" ${isSelected ? 'checked' : ''}
              onchange="toggleWorkSelect('${escapeHtml(work.identifier)}', this)">
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${labelClass} shrink-0">${labelText}</span>
            <div class="flex-1 min-w-0">
              <h3 class="text-sm md:text-base font-semibold text-text-primary leading-snug mb-1">
                <a href="${escapeHtml(work.url || '#')}" target="_blank" rel="noopener" class="hover:text-accent transition-colors">${title}</a>
              </h3>
              ${work.translated_title ? `<p class="text-xs text-text-secondary mb-1">${escapeHtml(work.translated_title)}</p>` : ''}
              <div class="flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-text-secondary">
                <span>${venue}</span>
                ${work.impact_factor ? `<span class="text-blue-600">IF: ${work.impact_factor.toFixed(1)}</span>` : ''}
                ${work.domain ? `<span class="text-purple-600">${escapeHtml(work.domain)}</span>` : ''}
                <span>Â· ${published}</span>
                ${work.label === 'followed' && work.extra?.followed_author
                  ? (archiveData && archiveData.group_by === 'author'
                    ? ''
                    : `<span class="text-blue-600">Â· å…³æ³¨: ${escapeHtml(work.extra.followed_author)}</span>`)
                  : `<span>Â· è¯„åˆ† ${work.score.toFixed(2)}</span>`}
              </div>
              <p class="text-xs text-text-secondary mt-1">${authors}${hasMore ? ' ç­‰' : ''}</p>
              ${hasSummary ? `<div class="paper-summary mt-2">
                <button onclick="toggleSection('${summaryId}')" class="text-xs text-accent hover:text-accent-hover flex items-center gap-1">
                  <span>AI æ€»ç»“</span>
                  <svg class="w-3 h-3 transform transition-transform" id="icon-${summaryId}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div id="${summaryId}" class="section-expand collapsed">
                  <div class="text-xs text-text-secondary mt-2 leading-relaxed bg-blue-50/50 p-3 rounded space-y-1.5">
                    ${buildSummaryHTML(work.summary_bullets)}
                  </div>
                </div>
              </div>` : ''}
              ${work.abstract ? `<div class="paper-abstract mt-2">
                <button onclick="toggleSection('${abstractId}')" class="text-xs text-accent hover:text-accent-hover flex items-center gap-1">
                  <span>æŸ¥çœ‹æ‘˜è¦</span>
                  <svg class="w-3 h-3 transform transition-transform" id="icon-${abstractId}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div id="${abstractId}" class="section-expand collapsed">
                  <p class="text-xs text-text-secondary mt-2 leading-relaxed bg-bg-hover/50 p-3 rounded">${searchQuery ? highlightText(work.abstract, searchQuery) : escapeHtml(work.abstract)}</p>
                </div>
              </div>` : ''}
              <div class="paper-details flex flex-wrap gap-2 mt-2 text-xs">
                ${work.doi ? `<a href="https://doi.org/${escapeHtml(work.doi)}" target="_blank" rel="noopener" class="text-accent hover:underline">DOI</a>` : ''}
                <span class="text-text-secondary">ç›¸ä¼¼åº¦ ${work.similarity.toFixed(2)}</span>
              </div>
            </div>
          </div>
        </article>`;
      }

      function renderChunk(state, count) {
        const chunkSize = count || (state.rendered === 0 ? CONFIG.initialPageSize : CONFIG.pageSize);
        const { works, list, groupId } = state;
        const start = state.rendered;
        const end = Math.min(start + chunkSize, works.length);
        if (start >= end) return;

        const htmlParts = [];
        for (let i = start; i < end; i++) {
          htmlParts.push(createArticleHTML(works[i], groupId, i));
        }
        list.insertAdjacentHTML('beforeend', htmlParts.join(''));
        state.rendered = end;

        const btn = state.loadMoreBtn;
        if (btn) {
          if (state.rendered >= works.length) {
            btn.style.display = 'none';
          } else {
            btn.textContent = `åŠ è½½æ›´å¤š (${works.length - state.rendered} å‰©ä½™)`;
            btn.style.display = 'block';
          }
        }
      }

      function setupLazyLoad(state) {
        if (!intersectionObserver) {
          intersectionObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const groupId = entry.target.dataset.groupId;
                const s = groupStates.get(groupId);
                if (s && s.rendered < s.works.length) {
                  renderChunk(s);
                }
              }
            });
          }, { rootMargin: '200px' });
        }

        const sentinel = document.createElement('div');
        sentinel.className = 'load-sentinel h-1';
        sentinel.dataset.groupId = state.groupId;
        state.list.parentElement.appendChild(sentinel);
        intersectionObserver.observe(sentinel);
        state.sentinel = sentinel;
      }

      function createGroupSection(group, gIdx, groupBy) {
        const groupId = `g${gIdx}-${normalizeGroupId(group.name)}`;
        const section = document.createElement('section');
        section.className = 'group-section';
        section.dataset.group = group.name;
        section.dataset.groupId = groupId;
        section.dataset.groupIndex = gIdx;

        const header = document.createElement('div');
        let headerExtra = '';
        if (groupBy === 'author') {
          headerExtra = group.name === 'AI æ¨è' ? ' group-header-ai' : ' group-header-author';
        }
        header.className = 'group-header flex items-center justify-between p-3 bg-bg-card rounded-lg border border-border-color mb-3 cursor-pointer' + headerExtra;
        header.onclick = () => toggleGroup(groupId);

        let titleContent = '';
        if (groupBy === 'label') {
          const dotClass = group.name === 'must_read' ? 'bg-green-500' : (group.name === 'consider' ? 'bg-amber-500' : (group.name === 'followed' ? 'bg-blue-500' : 'bg-gray-400'));
          const labelName = group.name === 'must_read' ? 'å¿…è¯»' : (group.name === 'consider' ? 'æ¨è' : (group.name === 'followed' ? 'å…³æ³¨' : 'å‚è€ƒ'));
          titleContent = `<span class="w-3 h-3 rounded-full ${dotClass} mr-2"></span>${labelName}`;
        } else if (groupBy === 'author') {
          const isAI = group.name === 'AI æ¨è';
          const iconSvg = isAI
            ? '<svg class="w-4 h-4 mr-2 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>'
            : '<svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>';
          titleContent = `${iconSvg}<span class="${isAI ? 'text-amber-700' : 'text-blue-700'}">${escapeHtml(group.name)}</span>`;
        } else {
          titleContent = escapeHtml(group.name);
        }

        header.innerHTML = `
          <div class="flex items-center">
            <svg class="w-4 h-4 mr-2 text-text-secondary rotate-icon" id="icon-group-${groupId}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
            <h2 class="text-base font-semibold text-text-primary flex items-center">${titleContent}</h2>
          </div>
          <span class="text-sm text-text-secondary">${group.filteredWorks.length} ç¯‡</span>
        `;
        section.appendChild(header);

        const contentWrapper = document.createElement('div');
        contentWrapper.id = `content-${groupId}`;
        contentWrapper.className = 'group-content';

        const list = document.createElement('div');
        list.className = 'space-y-3';
        contentWrapper.appendChild(list);

        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.className = 'mt-3 w-full px-4 py-2 text-sm font-medium text-accent border border-accent/30 rounded-lg hover:bg-accent/10 transition-colors';
        loadMoreBtn.style.display = 'none';
        contentWrapper.appendChild(loadMoreBtn);

        section.appendChild(contentWrapper);

        return { section, groupId, list, loadMoreBtn };
      }

      function renderGroups(data) {
        const container = document.getElementById('archive-groups');
        const noResults = document.getElementById('no-results');
        const searchInfo = document.getElementById('search-info');

        // Cleanup observers
        if (intersectionObserver) intersectionObserver.disconnect();
        if (groupObserver) groupObserver.disconnect();
        groupStates.clear();

        const filteredGroups = getFilteredGroups(data);
        const totalFiltered = filteredGroups.reduce((sum, g) => sum + g.filteredWorks.length, 0);

        // Update visible count in toolbar
        document.getElementById('visible-count').textContent = totalFiltered;

        // Update search info
        const hasAnyFilter = Object.entries(filters).some(([k, v]) => k !== 'sort' && v);
        if (searchQuery && searchQuery.length >= CONFIG.searchMinLength) {
          searchInfo.textContent = `æ‰¾åˆ° ${totalFiltered} ç¯‡åŒ¹é… "${searchQuery}" çš„æ–‡çŒ®`;
          searchInfo.classList.remove('hidden');
        } else if (hasAnyFilter) {
          const parts = [];
          if (filters.author) parts.push(`ä½œè€…: ${filters.author}`);
          if (filters.domain) parts.push(`é¢†åŸŸ: ${filters.domain}`);
          if (filters.source) parts.push(`æ¥æº: ${filters.source}`);
          if (filters.label) parts.push(`æ ‡ç­¾: ${filters.label}`);
          if (filters.month) parts.push(`æœˆä»½: ${filters.month}`);
          searchInfo.textContent = `ç­›é€‰ç»“æœ: ${totalFiltered} ç¯‡ (${parts.join('; ')})`;
          searchInfo.classList.remove('hidden');
        } else {
          searchInfo.classList.add('hidden');
        }

        if (filteredGroups.length === 0) {
          container.innerHTML = '';
          noResults.classList.remove('hidden');
          return;
        }

        noResults.classList.add('hidden');
        container.innerHTML = '';

        // Setup group observer for lazy loading remaining groups
        if (!groupObserver) {
          groupObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const section = entry.target;
                const groupId = section.dataset.groupId;
                const state = groupStates.get(groupId);
                if (state && !state.initialized) {
                  state.initialized = true;
                  renderChunk(state);
                  if (state.works.length > state.rendered) {
                    setupLazyLoad(state);
                  }
                }
                groupObserver.unobserve(section);
              }
            });
          }, { rootMargin: '100px' });
        }

        // Render groups progressively
        const fragment = document.createDocumentFragment();

        filteredGroups.forEach((group, gIdx) => {
          const { section, groupId, list, loadMoreBtn } = createGroupSection(group, gIdx, data.group_by);

          const state = {
            groupId,
            works: group.filteredWorks,
            list,
            rendered: 0,
            loadMoreBtn,
            sentinel: null,
            initialized: false
          };
          groupStates.set(groupId, state);

          loadMoreBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            renderChunk(state);
          });

          // Immediately render first few groups, lazy load rest
          if (gIdx < CONFIG.maxGroupsInitial) {
            state.initialized = true;
            renderChunk(state);
            if (state.works.length > state.rendered) {
              setupLazyLoad(state);
            }
          } else {
            // Defer rendering with intersection observer
            groupObserver.observe(section);
          }

          fragment.appendChild(section);
        });

        container.appendChild(fragment);

        // Update total display
        if (hasAnyFilter || searchQuery) {
          document.getElementById('stat-total').textContent = `${totalFiltered} / ${data.stats.total}`;
        } else {
          document.getElementById('stat-total').textContent = data.stats.total;
        }
      }

      const debouncedRender = debounce(() => {
        if (archiveData) {
          // Invalidate cache for any change
          filterCache = { key: '', result: null };
          // Use RAF for smoother rendering
          requestAnimationFrame(() => renderGroups(archiveData));
        }
      }, CONFIG.debounceDelay);

      // â”€â”€ Event listeners â”€â”€

      // Search
      const searchInput = document.getElementById('search-input');
      const clearSearch = document.getElementById('clear-search');

      searchInput.addEventListener('input', debounce((e) => {
        searchQuery = e.target.value.trim();
        clearSearch.classList.toggle('hidden', !searchQuery);
        debouncedRender();
      }, CONFIG.debounceDelay));

      clearSearch.addEventListener('click', () => {
        searchInput.value = '';
        searchQuery = '';
        clearSearch.classList.add('hidden');
        debouncedRender();
      });

      // View toggle
      document.getElementById('toggle-view').addEventListener('click', () => {
        isCompactView = !isCompactView;
        document.getElementById('main-content').classList.toggle('compact-view', isCompactView);
        document.getElementById('view-label').textContent = isCompactView ? 'ç´§å‡‘' : 'å®Œæ•´';
      });

      // Expand/collapse all
      document.getElementById('expand-all').addEventListener('click', () => {
        allGroupsExpanded = !allGroupsExpanded;
        document.querySelectorAll('.group-content').forEach(content => {
          content.classList.toggle('collapsed', !allGroupsExpanded);
        });
        document.querySelectorAll('.rotate-icon').forEach(icon => {
          icon.classList.toggle('collapsed', !allGroupsExpanded);
        });
      });

      // Reset search
      document.getElementById('reset-search').addEventListener('click', () => {
        Object.keys(filters).forEach(k => { if (k !== 'sort') filters[k] = ''; });
        filters.sort = 'newest';
        searchQuery = '';
        searchInput.value = '';
        clearSearch.classList.add('hidden');
        // Reset all pill active states
        document.querySelectorAll('.pill[data-filter]').forEach(p => p.classList.toggle('active', p.dataset.value === ''));
        document.querySelectorAll('#sort-pills .pill').forEach(p => p.classList.toggle('active', p.dataset.sort === 'newest'));
        debouncedRender();
      });

      // Selection toolbar
      document.getElementById('select-all-btn').addEventListener('click', selectAllVisible);
      document.getElementById('clear-selection-btn').addEventListener('click', clearSelection);

      // Export button + dropdown
      const exportBtn = document.getElementById('export-btn');
      const exportDropdown = document.getElementById('export-dropdown');

      exportBtn.addEventListener('click', () => {
        if (selectedWorks.size === 0) return;
        exportDropdown.classList.toggle('hidden');
      });

      exportDropdown.querySelectorAll('button[data-format]').forEach(btn => {
        btn.addEventListener('click', () => doExport(btn.dataset.format));
      });

      // Close dropdown on outside click
      document.addEventListener('click', (e) => {
        if (!exportBtn.contains(e.target) && !exportDropdown.contains(e.target)) {
          exportDropdown.classList.add('hidden');
        }
      });

      // Back to top
      const backToTop = document.getElementById('back-to-top');
      window.addEventListener('scroll', () => {
        backToTop.classList.toggle('visible', window.scrollY > 300);
      });
      backToTop.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          e.preventDefault();
          searchInput.focus();
        }
        if (e.key === 'Escape') {
          if (document.activeElement === searchInput) {
            searchInput.value = '';
            searchQuery = '';
            clearSearch.classList.add('hidden');
            searchInput.blur();
            debouncedRender();
          }
          exportDropdown.classList.add('hidden');
        }
      });

      // â”€â”€ Load data â”€â”€

      fetch(dataUrl)
        .then(response => response.json())
        .then(data => {
          archiveData = data;
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('main-content').classList.remove('hidden');
          updateStats(data.stats);
          buildAllFilters(data);
          renderGroups(data);
        })
        .catch(err => {
          console.error('Failed to load archive data:', err);
          document.getElementById('loading').innerHTML =
            '<p class="text-center text-red-500">åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
        });

    })();
  </script>
</body>

</html>